import React, { useEffect, useRef, useState } from "react";
import "./App.css";

import { fetchModels, requestIsoChat } from "./api/isoChatApi";

import {
  ModelOption,
  RunMode,
  AnswerMode,
  Message,
  Conversation,
  Guide,
  AttachedFile,
} from "./types/isoChat";

import Sidebar from "./components/Sidebar";
import ChatPanel from "./components/ChatPanel";
import GuidePanel from "./components/GuidePanel";

const App: React.FC = () => {
  /* --------------------------------
   * 1. 모델 / 실행 모드 상태
   * -------------------------------- */
  const [model, setModel] = useState<ModelOption>("gpt-5.1");
  const [modelList, setModelList] = useState<{ id: string; label: string }[]>([]);
  const [runMode, setRunMode] = useState<RunMode>("responses");
  const [answerMode, setAnswerMode] = useState<AnswerMode>("strict");

  useEffect(() => {
    fetchModels()
      .then((models) => setModelList(models))
      .catch(() => {
        // 실패 시 기본값
        setModelList([
          { id: "gpt-5.1", label: "gpt-5.1" },
          { id: "gpt-4.1", label: "gpt-4.1" },
          { id: "gpt-4.1-mini", label: "gpt-4.1-mini" },
        ]);
      });
  }, []);

  /* --------------------------------
   * 2. 대화방 / 메시지 상태
   * -------------------------------- */
  const [conversations, setConversations] = useState<Conversation[]>(() => {
    const saved = localStorage.getItem("conversations");
    if (!saved) return [];
    try {
      return JSON.parse(saved);
    } catch {
      return [];
    }
  });

  const [activeConversationId, setActiveConversationId] = useState<string | null>(
    () => (conversations[0] ? conversations[0].id : null)
  );

  useEffect(() => {
    localStorage.setItem("conversations", JSON.stringify(conversations));
  }, [conversations]);

  const activeConversation: Conversation | null =
    conversations.find((c) => c.id === activeConversationId) || null;

  const handleNewConversation = () => {
    const id = `c-${Date.now()}-${Math.random().toString(36).slice(2)}`;
    const conv: Conversation = {
      id,
      title: "새 테마",
      createdAt: new Date().toLocaleString(),
      messages: [],
    };
    setConversations((prev) => [conv, ...prev]);
    setActiveConversationId(id);
  };

  const handleDeleteConversation = (id: string) => {
    setConversations((prev) => {
      const filtered = prev.filter((c) => c.id !== id);
      if (id === activeConversationId) {
        setActiveConversationId(filtered[0]?.id ?? null);
      }
      return filtered;
    });
  };

  /* --------------------------------
   * 3. 테마 제목 인라인 수정
   * -------------------------------- */
  const [editingConvId, setEditingConvId] = useState<string | null>(null);
  const [editingTitle, setEditingTitle] = useState("");

  const handleEditTitleStart = (conv: Conversation) => {
    setEditingConvId(conv.id);
    setEditingTitle(conv.title);
  };

  const handleEditTitleSave = (id: string) => {
    setConversations((prev) =>
      prev.map((c: Conversation) =>
        c.id === id
          ? {
              ...c,
              title: editingTitle.trim() || c.title,
            }
          : c
      )
    );
    setEditingConvId(null);
    setEditingTitle("");
  };

  /* --------------------------------
   * 4. 지침 / 가이드 상태
   * -------------------------------- */
  const [globalGuides, setGlobalGuides] = useState<Guide[]>([]);
  const [conversationGuides, setConversationGuides] = useState<Record<string, Guide[]>>({});
  const [isGuidePanelOpen, setIsGuidePanelOpen] = useState(false);

  const activeConvGuides: Guide[] = activeConversationId
    ? conversationGuides[activeConversationId] || []
    : [];

  const handleCreateGuide = (scope: "global" | "conversation") => {
    const id = `g-${Date.now()}-${Math.random().toString(36).slice(2)}`;
    const base: Guide = {
      id,
      scope,
      conversationId: scope === "conversation" ? activeConversationId || undefined : undefined,
      title: "",
      content: "",
      files: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };

    if (scope === "global") {
      setGlobalGuides((prev) => [base, ...prev]);
    } else if (activeConversationId) {
      setConversationGuides((prev) => ({
        ...prev,
        [activeConversationId]: [base, ...(prev[activeConversationId] || [])],
      }));
    }
  };

  const handleUpdateGuide = (guide: Guide) => {
    if (guide.scope === "global") {
      setGlobalGuides((prev) =>
        prev.map((g: Guide) => (g.id === guide.id ? guide : g))
      );
      return;
    }

    if (guide.scope === "conversation") {
      const convId = guide.conversationId;
      if (!convId) return; // 안전장치

      setConversationGuides((prev) => {
        const list: Guide[] = prev[convId] || [];
        return {
          ...prev,
          [convId]: list.map((g: Guide) => (g.id === guide.id ? guide : g)),
        };
      });
    }
  };

  const handleDeleteGuide = (id: string, scope: "global" | "conversation") => {
    if (scope === "global") {
      setGlobalGuides((prev) => prev.filter((g: Guide) => g.id !== id));
      return;
    }

    if (scope === "conversation") {
      const convId = activeConversationId;
      if (!convId) return; // 안전장치

      setConversationGuides((prev) => {
        const list: Guide[] = prev[convId] || [];
        return {
          ...prev,
          [convId]: list.filter((g: Guide) => g.id !== id),
        };
      });
    }
  };

  /* --------------------------------
   * 5. 첨부 파일 상태
   * -------------------------------- */
  const [attachedFiles, setAttachedFiles] = useState<AttachedFile[]>([]);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleDrop = (e: React.DragEvent<HTMLTextAreaElement>) => {
    e.preventDefault();
    const files = Array.from(e.dataTransfer.files || []);
    if (!files.length) return;

    setAttachedFiles((prev) => [
      ...prev,
      ...files.map<AttachedFile>((file) => ({
        id: `af-${Date.now()}-${Math.random().toString(36).slice(2)}`,
        name: file.name,
        file,
      })),
    ]);
  };

  const handleFileInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;

    setAttachedFiles((prev) => [
      ...prev,
      ...files.map<AttachedFile>((file) => ({
        id: `af-${Date.now()}-${Math.random().toString(36).slice(2)}`,
        name: file.name,
        file,
      })),
    ]);

    e.target.value = "";
  };

  const handleRemoveAttachedFile = (id: string) => {
    setAttachedFiles((prev) => prev.filter((f) => f.id !== id));
  };

  /* --------------------------------
   * 6. 입력 / 전송 / 에러 상태
   * -------------------------------- */
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e?: React.FormEvent) => {
    if (e) e.preventDefault();
    if (!activeConversationId) return;

    const trimmed = input.trim();
    if (!trimmed) return;

    const currentConv = conversations.find((c) => c.id === activeConversationId);
    if (!currentConv) return;

    const userMsg: Message = { role: "user", content: trimmed };
    const newMessages = [...currentConv.messages, userMsg];

    // 1) UI 먼저 업데이트
    setConversations((prev) =>
      prev.map((c: Conversation) =>
        c.id === activeConversationId ? { ...c, messages: newMessages } : c
      )
    );
    setInput("");
    setLoading(true);
    setError(null);

    try {
      const payload = {
        model,
        runMode,
        answerMode,
        messages: newMessages,
        globalGuides: globalGuides.map((g: Guide) => ({
          id: g.id,
          title: g.title,
          content: g.content,
        })),
        convGuides: activeConvGuides.map((g: Guide) => ({
          id: g.id,
          title: g.title,
          content: g.content,
        })),
      };

      const res = await requestIsoChat(payload);
      const assistantText: string =
        res?.reply?.content || res?.reply || res?.content || "";

      const assistantMsg: Message = {
        role: "assistant",
        content:
          assistantText && assistantText.trim().length > 0
            ? assistantText
            : "유효한 정보를 찾지 못했습니다. 추가 기초 정보를 제공해 주시면 더 정확한 답변을 드리겠습니다.",
      };

      setConversations((prev) =>
        prev.map((c: Conversation) =>
          c.id === activeConversationId
            ? { ...c, messages: [...c.messages, assistantMsg] }
            : c
        )
      );
    } catch (err: any) {
      console.error(err);
      setError(
        err?.message ||
          "ISO Expert 서버 호출 중 오류가 발생했습니다. 서버 로그를 확인해 주세요."
      );
    } finally {
      setLoading(false);
    }
  };

  /* --------------------------------
   * 7. 렌더링 (3단 레이아웃 조립)
   * -------------------------------- */
  return (
    <div className="iso-app-root">
      {/* 좌측: 테마 / 대화 리스트 */}
      <Sidebar
        conversations={conversations}
        activeConversationId={activeConversationId || ""}
        onNewConversation={handleNewConversation}
        onSelectConversation={setActiveConversationId}
        onDeleteConversation={handleDeleteConversation}
        editingConvId={editingConvId}
        editingTitle={editingTitle}
        onEditTitleStart={handleEditTitleStart}
        onEditTitleSave={handleEditTitleSave}
        setEditingTitle={setEditingTitle}
        onReorderConversations={undefined}
      />

      {/* 중앙: 메인 채팅 패널 (분리된 ChatPanel) */}
      <ChatPanel
        activeConversation={activeConversation}
        attachedFiles={attachedFiles}
        input={input}
        loading={loading}
        error={error}
        onChangeInput={setInput}
        onSubmit={handleSubmit}
        onDrop={handleDrop}
        onRemoveAttachedFile={handleRemoveAttachedFile}
        fileInputRef={fileInputRef}
        onFileInputChange={handleFileInputChange}
      />

      {/* 우측: 설정 / 상태 패널 */}
      <aside className="iso-rightbar">
        <div className="iso-rightbar-header">대화 설정 / 기능</div>

        <div className="iso-rightbar-main">
          {/* 현재 테마 정보 */}
          <div className="iso-rightbar-section">
            <div className="iso-rightbar-section-title">현재 테마 정보</div>
            {activeConversation ? (
              <>
                <div style={{ fontSize: 12, marginBottom: 4 }}>
                  제목: <strong>{activeConversation.title}</strong>
                </div>
                <div
                  style={{
                    fontSize: 11,
                    color: "#9ca3af",
                    marginBottom: 4,
                  }}
                >
                  생성: {activeConversation.createdAt}
                </div>
                <div style={{ fontSize: 12 }}>
                  메시지 수: {activeConversation.messages.length}
                </div>
              </>
            ) : (
              <div style={{ fontSize: 12, color: "#9ca3af" }}>
                활성화된 테마가 없습니다.
              </div>
            )}
          </div>

          {/* 모델 / 실행 방식 */}
          <div className="iso-rightbar-section">
            <div className="iso-rightbar-section-title">모델 / 실행 방식</div>
            <div className="iso-main-controls" style={{ marginBottom: 8 }}>
              <div className="iso-main-control">
                <label className="iso-label">모델 선택</label>
                <select
                  value={model}
                  onChange={(e) => setModel(e.target.value as ModelOption)}
                >
                  {modelList.map((m) => (
                    <option key={m.id} value={m.id}>
                      {m.label}
                    </option>
                  ))}
                </select>
              </div>
              <div className="iso-main-control">
                <label className="iso-label">실행 방식</label>
                <select
                  value={runMode}
                  onChange={(e) => setRunMode(e.target.value as RunMode)}
                >
                  <option value="chat">일반 실행 (Chat API)</option>
                  <option value="responses">고급 실행 (Responses API)</option>
                </select>
              </div>
            </div>
            <div style={{ fontSize: 11, color: "#9ca3af" }}>
              ISO 전용 서버(WSL2/Docker)에서 지정한 모델과 실행 모드를 사용합니다.
            </div>
          </div>

          {/* 답변 모드 */}
          <div className="iso-rightbar-section">
            <div className="iso-rightbar-section-title">답변 모드</div>
            <div
              style={{
                display: "flex",
                gap: 12,
                justifyContent: "space-between",
              }}
            >
              <div
                style={{
                  flex: 1,
                  display: "flex",
                  flexDirection: "column",
                  alignItems: "center",
                }}
              >
                <button
                  type="button"
                  className={
                    "iso-answer-btn" + (answerMode === "strict" ? " active" : "")
                  }
                  onClick={() => setAnswerMode("strict")}
                  style={{
                    borderRadius: 999,
                    fontWeight: 600,
                    padding: "6px 18px",
                    background:
                      answerMode === "strict" ? "#5b21b6" : "#111827",
                    color: answerMode === "strict" ? "#fff" : "#e5e7eb",
                    border: 0,
                    fontSize: 13,
                    minWidth: 80,
                    transition: "background 0.2s, color 0.2s",
                  }}
                >
                  보수형
                </button>
                <div
                  style={{
                    fontSize: 11,
                    color: "#9ca3af",
                    marginTop: 4,
                    textAlign: "center",
                  }}
                >
                  공인 문서·실재 근거 위주의
                  <br />
                  정보만 사용
                </div>
              </div>
              <div
                style={{
                  flex: 1,
                  display: "flex",
                  flexDirection: "column",
                  alignItems: "center",
                }}
              >
                <button
                  type="button"
                  className={
                    "iso-answer-btn" +
                    (answerMode === "aggressive" ? " active" : "")
                  }
                  onClick={() => setAnswerMode("aggressive")}
                  style={{
                    borderRadius: 999,
                    fontWeight: 600,
                    padding: "6px 18px",
                    background:
                      answerMode === "aggressive" ? "#5b21b6" : "#111827",
                    color: answerMode === "aggressive" ? "#fff" : "#e5e7eb",
                    border: 0,
                    fontSize: 13,
                    minWidth: 80,
                    transition: "background 0.2s, color 0.2s",
                  }}
                >
                  적극형
                </button>
                <div
                  style={{
                    fontSize: 11,
                    color: "#9ca3af",
                    marginTop: 4,
                    textAlign: "center",
                  }}
                >
                  ISO 논리 구조는 유지하되
                  <br />
                  생성형 보조 설명 허용
                </div>
              </div>
            </div>
          </div>

          {/* 첨부 파일 요약 */}
          <div className="iso-rightbar-section">
            <div className="iso-rightbar-section-title">첨부 파일</div>
            {attachedFiles.length === 0 ? (
              <div style={{ fontSize: 12, color: "#9ca3af" }}>
                아직 첨부된 파일이 없습니다.
              </div>
            ) : (
              <div className="iso-rightbar-files">
                {attachedFiles.map((file) => (
                  <div
                    key={file.id}
                    style={{
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "space-between",
                      fontSize: 12,
                      padding: "4px 0",
                      borderBottom: "1px solid #111827",
                    }}
                  >
                    <span
                      style={{
                        maxWidth: 160,
                        whiteSpace: "nowrap",
                        overflow: "hidden",
                        textOverflow: "ellipsis",
                      }}
                    >
                      {file.name}
                    </span>
                    <button
                      type="button"
                      onClick={() => handleRemoveAttachedFile(file.id)}
                      style={{
                        border: 0,
                        background: "transparent",
                        color: "#f97373",
                        cursor: "pointer",
                        fontSize: 11,
                      }}
                    >
                      삭제
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* 지침 / 가이드 요약 */}
          <div className="iso-rightbar-section">
            <div className="iso-rightbar-section-title">지침 / 가이드</div>
            <div style={{ fontSize: 12, marginBottom: 4 }}>
              공통 지침:{" "}
              <span style={{ fontWeight: 700 }}>{globalGuides.length}</span> 개
            </div>
            <div style={{ fontSize: 12, marginBottom: 8 }}>
              이 대화방 지침:{" "}
              <span style={{ fontWeight: 700 }}>{activeConvGuides.length}</span> 개
            </div>
            <button
              type="button"
              onClick={() => setIsGuidePanelOpen(true)}
              style={{
                width: "100%",
                borderRadius: 999,
                border: "1px solid #4b5563",
                background: "#111827",
                color: "#e5e7eb",
                fontSize: 12,
                padding: "6px 10px",
                cursor: "pointer",
              }}
            >
              지침 / 가이드 패널 열기
            </button>
          </div>
        </div>
      </aside>

      {/* 플로팅 지침/가이드 패널 */}
      <GuidePanel
        isOpen={isGuidePanelOpen}
        onClose={() => setIsGuidePanelOpen(false)}
        globalGuides={globalGuides}
        conversationGuides={activeConvGuides}
        activeConversationId={activeConversationId}
        onCreateGuide={handleCreateGuide}
        onUpdateGuide={handleUpdateGuide}
        onDeleteGuide={handleDeleteGuide}
        setGlobalGuides={setGlobalGuides}
        setConversationGuides={setConversationGuides}
      />
    </div>
  );
};

export default App;
