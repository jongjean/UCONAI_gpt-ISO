import React, { useEffect, useRef, useState } from "react";
import "./App.css";

type ModelOption = string;
type RunMode = "chat" | "responses";
type AnswerMode = "strict" | "aggressive";

type Message = {
  role: "user" | "assistant";
  content: string;
};

type Conversation = {
  id: string;
  title: string;
  createdAt: string;
  messages: Message[];
};

type GuideFile = {
  id: string;
  name: string;
  size: number;
  type: string;
  url: string;
  createdAt: string;
};

type Guide = {
  id: string;
  scope: "global" | "conversation";
  conversationId?: string;
  title: string;
  content: string;
  files: GuideFile[];
  createdAt: string;
  updatedAt: string;
};

type AttachedFile = {
  id: string;
  name: string;
  file: File;
};

const API_BASE = "http://localhost:4400";

const ClipIcon: React.FC = () => (
  <span style={{ fontSize: 16, display: "inline-flex", alignItems: "center" }}>
    ğŸ“
  </span>
);

type GuidePanelProps = {
  isOpen: boolean;
  onClose: () => void;
  globalGuides: Guide[];
  conversationGuides: Guide[];
  activeConversationId: string | null;
  onCreateGuide: (scope: "global" | "conversation") => void;
  onUpdateGuide: (guide: Guide) => void;
  onDeleteGuide: (id: string, scope: "global" | "conversation") => void;
};

const GuidePanel: React.FC<GuidePanelProps> = ({
  isOpen,
  onClose,
  globalGuides,
  conversationGuides,
  activeConversationId,
  onCreateGuide,
  onUpdateGuide,
  onDeleteGuide,
}) => {
  const [tab, setTab] = useState<"global" | "conversation">("global");
  const [editing, setEditing] = useState<Guide | null>(null);

  // ì´ë™ ê´€ë ¨ ìƒíƒœ
  const [pos, setPos] = useState<{ x: number; y: number }>({ x: window.innerWidth / 2 - 360, y: window.innerHeight / 2 - 320 });
  const [dragging, setDragging] = useState(false);
  const [offset, setOffset] = useState<{ x: number; y: number }>({ x: 0, y: 0 });
  const panelRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    setEditing(null);
  }, [tab, activeConversationId]);

  // ë“œë˜ê·¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
  const handleMouseDown = (e: React.MouseEvent) => {
    if (panelRef.current) {
      setDragging(true);
      setOffset({
        x: e.clientX - pos.x,
        y: e.clientY - pos.y,
      });
    }
  };
  useEffect(() => {
    if (!dragging) return;
    const handleMouseMove = (e: MouseEvent) => {
      setPos({
        x: Math.max(0, Math.min(window.innerWidth - 720, e.clientX - offset.x)),
        y: Math.max(0, Math.min(window.innerHeight - 100, e.clientY - offset.y)),
      });
    };
    const handleMouseUp = () => setDragging(false);
    window.addEventListener("mousemove", handleMouseMove);
    window.addEventListener("mouseup", handleMouseUp);
    return () => {
      window.removeEventListener("mousemove", handleMouseMove);
      window.removeEventListener("mouseup", handleMouseUp);
    };
  }, [dragging, offset]);

  useEffect(() => {
    // ì°½ í¬ê¸° ë³€ê²½ ì‹œ íŒ¨ë„ ìœ„ì¹˜ ë³´ì •
    setPos((prev) => ({
      x: Math.min(prev.x, window.innerWidth - 720),
      y: Math.min(prev.y, window.innerHeight - 100),
    }));
    // eslint-disable-next-line
  }, [window.innerWidth, window.innerHeight]);

  if (!isOpen) return null;

  const currentList = tab === "global" ? globalGuides : conversationGuides;

  const handleChangeTitle = (value: string) => {
    if (!editing) return;
    const updated = { ...editing, title: value, updatedAt: new Date().toISOString() };
    setEditing(updated);
    onUpdateGuide(updated);
  };

  const handleChangeContent = (value: string) => {
    if (!editing) return;
    const updated = { ...editing, content: value, updatedAt: new Date().toISOString() };
    setEditing(updated);
    onUpdateGuide(updated);
  };

  return (
    <>
      <div
        style={{
          position: "fixed",
          inset: 0,
          zIndex: 1000,
          background: "rgba(0,0,0,0.4)",
          pointerEvents: dragging ? "none" : "auto",
        }}
      />
      <div
        ref={panelRef}
        style={{
          position: "fixed",
          left: pos.x,
          top: pos.y,
          zIndex: 1001,
          background: "#111827",
          width: 720,
          maxHeight: "80vh",
          borderRadius: 16,
          padding: 24,
          color: "#fff",
          display: "flex",
          flexDirection: "column",
          boxShadow: "0 8px 32px rgba(0,0,0,0.25)",
          cursor: dragging ? "grabbing" : undefined,
          userSelect: dragging ? "none" : undefined,
        }}
      >
        {/* í—¤ë” */}
        <div
          style={{
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
            marginBottom: 12,
            cursor: "grab",
            userSelect: "none",
            position: "relative",
          }}
          onMouseDown={handleMouseDown}
        >
          <div>
            <div style={{ fontWeight: 600, fontSize: 14 }}>ì§€ì¹¨ / ê°€ì´ë“œ ê´€ë¦¬</div>
            <div style={{ fontSize: 11, color: "#9ca3af", marginTop: 2 }}>
              í”„ë¡œì íŠ¸ ê³µí†µ ì§€ì¹¨ê³¼ ëŒ€í™”ë°©ë³„ ì§€ì¹¨ì„ êµ¬ë¶„í•´ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
            </div>
          </div>
          <button
            type="button"
            onClick={onClose}
            style={{
              position: "absolute",
              right: 0,
              top: "50%",
              transform: "translateY(-50%)",
              background: "#1f2937",
              color: "#fff",
              border: 0,
              borderRadius: "50%",
              width: 28,
              height: 28,
              fontWeight: 700,
              fontSize: 16,
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              cursor: "pointer",
              boxShadow: "0 2px 8px rgba(0,0,0,0.10)",
              zIndex: 2,
              lineHeight: 1,
              padding: 0,
              transition: "background 0.15s",
            }}
            aria-label="ë‹«ê¸°"
          >
            X
          </button>
        </div>

        {/* íƒ­ */}
        <div style={{ display: "flex", gap: 8, marginBottom: 12 }}>
          <button
            onClick={() => setTab("global")}
            style={{
              flex: 1,
              border: 0,
              borderRadius: 999,
              padding: "6px 10px",
              background: tab === "global" ? "#7c3aed" : "#1f2937",
              color: tab === "global" ? "#fff" : "#9ca3af",
              fontSize: 12,
              cursor: "pointer",
            }}
          >
            í”„ë¡œì íŠ¸ ê³µí†µ ì§€ì¹¨
          </button>
          <button
            onClick={() => setTab("conversation")}
            style={{
              flex: 1,
              border: 0,
              borderRadius: 999,
              padding: "6px 10px",
              background: tab === "conversation" ? "#7c3aed" : "#1f2937",
              color: tab === "conversation" ? "#fff" : "#9ca3af",
              fontSize: 12,
              cursor: "pointer",
            }}
            disabled={!activeConversationId}
          >
            ì´ ëŒ€í™”ë°© ì§€ì¹¨
          </button>
        </div>

        {/* ë³¸ë¬¸ */}
        <div style={{ display: "flex", flex: 1, gap: 16, minHeight: 260 }}>
          {/* ë¦¬ìŠ¤íŠ¸ */}
          <div style={{ flex: 1, display: "flex", flexDirection: "column" }}>
            <button
              onClick={() => onCreateGuide(tab)}
              style={{
                alignSelf: "flex-start",
                marginBottom: 8,
                border: 0,
                borderRadius: 8,
                padding: "4px 10px",
                background: "#7c3aed",
                color: "#fff",
                fontSize: 12,
                cursor: "pointer",
              }}
            >
              + ìƒˆ ì§€ì¹¨ ì¶”ê°€
            </button>
            <div
              style={{
                flex: 1,
                overflowY: "auto",
                borderRadius: 8,
                border: "1px solid #1f2937",
                padding: 4,
              }}
            >
              {currentList.length === 0 ? (
                <div style={{ fontSize: 12, color: "#9ca3af", padding: 8 }}>
                  ì•„ì§ ë“±ë¡ëœ ì§€ì¹¨ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
              ) : (
                <ul
                  style={{
                    listStyle: "none",
                    margin: 0,
                    padding: 0,
                    fontSize: 12,
                  }}
                >
                  {currentList.map((g) => (
                    <li
                      key={g.id}
                      style={{
                        padding: 6,
                        borderRadius: 6,
                        marginBottom: 4,
                        cursor: "pointer",
                        background:
                          editing?.id === g.id ? "#1f2937" : "transparent",
                      }}
                      onClick={() => setEditing(g)}
                    >
                      <div style={{ fontWeight: 600, fontSize: 13 }}>
                        {g.title || "(ì œëª© ì—†ìŒ)"}
                      </div>
                      <div
                        style={{
                          marginTop: 2,
                          fontSize: 11,
                          color: "#9ca3af",
                          whiteSpace: "nowrap",
                          textOverflow: "ellipsis",
                          overflow: "hidden",
                        }}
                      >
                        {g.content || "ë‚´ìš© ì—†ìŒ"}
                      </div>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          onDeleteGuide(g.id, tab);
                          if (editing?.id === g.id) setEditing(null);
                        }}
                        style={{
                          marginTop: 2,
                          border: 0,
                          background: "none",
                          color: "#f97373",
                          fontSize: 11,
                          cursor: "pointer",
                        }}
                      >
                        ì‚­ì œ
                      </button>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </div>

          {/* í¸ì§‘ ì˜ì—­ */}
          <div style={{ flex: 2, display: "flex", flexDirection: "column" }}>
            {editing ? (
              <>
                <input
                  value={editing.title}
                  onChange={(e) => handleChangeTitle(e.target.value)}
                  placeholder="ì§€ì¹¨ ì œëª©"
                  style={{
                    width: "100%",
                    marginBottom: 8,
                    borderRadius: 6,
                    border: "1px solid #374151",
                    padding: 8,
                    fontSize: 13,
                    background: "#111827",
                    color: "#f9fafb",
                  }}
                />
                <textarea
                  value={editing.content}
                  onChange={(e) => handleChangeContent(e.target.value)}
                  placeholder="ì§€ì¹¨ ë‚´ìš© ë˜ëŠ” ISO ì‘ì„± ê°€ì´ë“œë¼ì¸ì„ ì…ë ¥í•˜ì„¸ìš”."
                  style={{
                    flex: 1,
                    width: "100%",
                    borderRadius: 6,
                    border: "1px solid #374151",
                    padding: 8,
                    fontSize: 13,
                    background: "#111827",
                    color: "#f9fafb",
                    resize: "none",
                  }}
                />
                <div
                  style={{
                    marginTop: 8,
                    fontSize: 11,
                    color: "#9ca3af",
                  }}
                >
                  â€» íŒŒì¼ ì²¨ë¶€/ë“œë˜ê·¸ì•¤ë“œë¡­, ì„œë²„ ì €ì¥ ì—°ë™ì€ ë‹¤ìŒ ë²„ì „ì—ì„œ í™•ì¥í•  ìˆ˜
                  ìˆìŠµë‹ˆë‹¤.
                </div>
              </>
            ) : (
              <div
                style={{
                  flex: 1,
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  fontSize: 12,
                  color: "#9ca3af",
                  textAlign: "center",
                }}
              >
                ì¢Œì¸¡ì—ì„œ ì§€ì¹¨ì„ ì„ íƒí•˜ê±°ë‚˜ &quot;ìƒˆ ì§€ì¹¨ ì¶”ê°€&quot; ë²„íŠ¼ì„ ëˆŒëŸ¬
                í¸ì§‘ì„ ì‹œì‘í•˜ì„¸ìš”.
              </div>
            )}
          </div>
        </div>
      </div>
  </>
  );
};

const App: React.FC = () => {
  const [model, setModel] = useState<ModelOption>("gpt-5.1");
  const [modelList, setModelList] = useState<{id: string; label: string}[]>([]);

  useEffect(() => {
    fetch("/api/models")
      .then(res => res.json())
      .then(data => setModelList(data.models))
      .catch(() => {
        setModelList([
          { id: "gpt-5.1", label: "gpt-5.1" },
          { id: "gpt-4.1", label: "gpt-4.1" },
          { id: "gpt-4.1-mini", label: "gpt-4.1-mini" },
        ]);
      });
  }, []);
  const [runMode, setRunMode] = useState<RunMode>("responses");
  const [answerMode, setAnswerMode] = useState<AnswerMode>("strict");

  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [conversations, setConversations] = useState<Conversation[]>(() => {
    const saved = localStorage.getItem("conversations");
    if (saved) return JSON.parse(saved);
    return [
      {
        id: "default",
        title: "ì‹ ê·œí…Œë§ˆ",
        createdAt: new Date().toLocaleString("ko-KR"),
        messages: [],
      },
    ];
  });
  const [activeConversationId, setActiveConversationId] = useState<string>(() => {
    return localStorage.getItem("activeConversationId") || "default";
  });
  const [attachedFiles, setAttachedFiles] = useState<AttachedFile[]>(() => {
    const saved = localStorage.getItem("attachedFiles");
    if (saved) return JSON.parse(saved);
    return [];
  });
  const [globalGuides, setGlobalGuides] = useState<Guide[]>(() => {
    const saved = localStorage.getItem("globalGuides");
    if (saved) return JSON.parse(saved);
    return [];
  });
  const [conversationGuides, setConversationGuides] = useState<Record<string, Guide[]>>(() => {
    const saved = localStorage.getItem("conversationGuides");
    if (saved) return JSON.parse(saved);
    return {};
  });
  // ìƒíƒœ ë³€ê²½ ì‹œ localStorageì— ë™ê¸°í™”
  useEffect(() => {
    localStorage.setItem("conversations", JSON.stringify(conversations));
  }, [conversations]);
  useEffect(() => {
    localStorage.setItem("activeConversationId", activeConversationId);
  }, [activeConversationId]);
  useEffect(() => {
    localStorage.setItem("attachedFiles", JSON.stringify(attachedFiles));
  }, [attachedFiles]);
  useEffect(() => {
    localStorage.setItem("globalGuides", JSON.stringify(globalGuides));
  }, [globalGuides]);
  useEffect(() => {
    localStorage.setItem("conversationGuides", JSON.stringify(conversationGuides));
  }, [conversationGuides]);

  const [isGuidePanelOpen, setIsGuidePanelOpen] = useState(false);

  const [editingConvId, setEditingConvId] = useState<string | null>(null);
  const [editingTitle, setEditingTitle] = useState<string>("");

  const fileInputRef = useRef<HTMLInputElement | null>(null);

  const activeConversation = conversations.find(
    (c) => c.id === activeConversationId
  );

  const activeConvGuides: Guide[] =
    conversationGuides[activeConversationId] || [];

  const handleNewConversation = () => {
    const id = `conv-${Date.now()}`;
    const newConv: Conversation = {
      id,
      title: "ìƒˆ í…Œë§ˆ",
      createdAt: new Date().toLocaleString("ko-KR"),
      messages: [],
    };
    setConversations((prev) => [newConv, ...prev]);
    setActiveConversationId(id);
  };

  const handleEditTitleStart = (conv: Conversation) => {
    setEditingConvId(conv.id);
    setEditingTitle(conv.title);
  };

  const handleEditTitleSave = (id: string) => {
    setConversations((prev) =>
      prev.map((c) =>
        c.id === id ? { ...c, title: editingTitle || c.title } : c
      )
    );
    setEditingConvId(null);
    setEditingTitle("");
  };

  const handleFileInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (!e.target.files) return;
    const files = Array.from(e.target.files);
    setAttachedFiles((prev) => [
      ...prev,
      ...files.map((f) => ({
        id: `${Date.now()}-${Math.random().toString(36).slice(2)}`,
        name: f.name,
        file: f,
      })),
    ]);
    e.target.value = "";
  };

  const handleDrop = (e: React.DragEvent<HTMLTextAreaElement>) => {
    e.preventDefault();
    if (!e.dataTransfer.files?.length) return;
    const files = Array.from(e.dataTransfer.files);
    setAttachedFiles((prev) => [
      ...prev,
      ...files.map((f) => ({
        id: `${Date.now()}-${Math.random().toString(36).slice(2)}`,
        name: f.name,
        file: f,
      })),
    ]);
  };

  const handleRemoveAttachedFile = (id: string) => {
    setAttachedFiles((prev) => prev.filter((f) => f.id !== id));
  };

  const renderMessages = () => {
    if (!activeConversation || activeConversation.messages.length === 0) {
      return <div className="iso-chat-empty">ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>;
    }

    return (
      <div className="iso-chat-messages">
        {activeConversation.messages.map((msg, idx) => (
          <div
            key={idx}
            className={
              "iso-chat-bubble " + (msg.role === "user" ? "user" : "ai")
            }
          >
            <div style={{ display: "flex", alignItems: "center", marginBottom: 2 }}>
              <span
                style={{
                  background: "#5b21b6",
                  color: "#fff",
                  borderRadius: 999,
                  padding: "2px 16px",
                  fontWeight: 600,
                  fontSize: 12,
                  marginRight: 8,
                  display: "inline-block",
                  minWidth: 36,
                  textAlign: "center",
                }}
              >
                {msg.role === "user" ? "ê°•ë°•ì‚¬ë‹˜" : "ìœ ì½”ë‚˜ì´-ISO Expert"}
              </span>
            </div>
            <div className="iso-chat-bubble-content">{msg.content}</div>
          </div>
        ))}
      </div>
    );
  };

  const renderAttachedFiles = () => (
    <div style={{ fontSize: 11, color: "#6b7280", marginTop: 4 }}>
      {attachedFiles.map((file) => (
        <span
          key={file.id}
          style={{
            display: "inline-flex",
            alignItems: "center",
            padding: "2px 6px",
            borderRadius: 999,
            background: "#e5e7eb",
            marginRight: 4,
            marginBottom: 2,
          }}
        >
          {file.name}
          <button
            type="button"
            onClick={() => handleRemoveAttachedFile(file.id)}
            style={{
              marginLeft: 4,
              border: 0,
              background: "transparent",
              color: "#b91c1c",
              cursor: "pointer",
              fontSize: 11,
            }}
          >
            Ã—
          </button>
        </span>
      ))}
    </div>
  );

  const handleSubmit = async (e?: React.FormEvent) => {
    if (e) e.preventDefault();
    const trimmed = input.trim();
    if (!trimmed || !activeConversation) return;

    setError(null);
    setLoading(true);

    const userMessage: Message = { role: "user", content: trimmed };

    setConversations((prev) =>
      prev.map((c) =>
        c.id === activeConversation.id
          ? { ...c, messages: [...c.messages, userMessage] }
          : c
      )
    );
    setInput("");

    try {
      const payload = {
        message: trimmed,
        model,
        mode: runMode,
        answerMode,
        globalGuides: globalGuides.map((g) => ({
          id: g.id,
          title: g.title,
          content: g.content,
        })),
        convGuides: activeConvGuides.map((g) => ({
          id: g.id,
          title: g.title,
          content: g.content,
        })),
      };

      console.log("[ISO-CHAT] request", {
        messagePreview: trimmed.slice(0, 60),
        model,
        runMode,
        answerMode,
      });

      const res = await fetch(`${API_BASE}/api/iso-chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const text = await res.text();
        console.error("[ISO-CHAT] error response", text);
        throw new Error(text || "ISO API error");
      }

      const data = await res.json();
      const assistantText: string =
        data?.reply?.content ||
        data?.reply ||
        data?.content ||
        "";

      console.log("[ISO-CHAT] success, reply length:", assistantText.length);

      const assistantMessage: Message = {
        role: "assistant",
        content:
          assistantText && assistantText.trim().length > 0
            ? assistantText
            : "ì •í™•í•œ ì •ë³´ê°€ ë¶€ì¡±í•˜ì§€ë§Œ, í–¥í›„ Deep Learningì„ ìœ„í•´ ê´€ë ¨ ìë£Œ(ì´ˆì•ˆ, TR, íšŒì˜ ë¬¸ì„œ ë“±)ë¥¼ ì œê³µí•´ì£¼ì‹œë©´ ë” êµ¬ì²´ì ìœ¼ë¡œ ë„ì™€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
      };

      setConversations((prev) =>
        prev.map((c) =>
          c.id === activeConversation.id
            ? { ...c, messages: [...c.messages, assistantMessage] }
            : c
        )
      );
    } catch (err: any) {
      console.error(err);
      setError(
        err?.message ||
          "ISO Expert ì„œë²„ í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í„°ë¯¸ë„ ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”."
      );
    } finally {
      setLoading(false);
    }
  };

  const handleCreateGuide = (scope: "global" | "conversation") => {
    const id = `g-${Date.now()}-${Math.random().toString(36).slice(2)}`;
    const base: Guide = {
      id,
      scope,
      conversationId:
        scope === "conversation" ? activeConversationId || undefined : undefined,
      title: "",
      content: "",
      files: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };

    if (scope === "global") {
      setGlobalGuides((prev) => [base, ...prev]);
    } else if (activeConversationId) {
      setConversationGuides((prev) => ({
        ...prev,
        [activeConversationId]: [base, ...(prev[activeConversationId] || [])],
      }));
    }
  };

  const handleUpdateGuide = (guide: Guide) => {
    if (guide.scope === "global") {
      setGlobalGuides((prev) =>
        prev.map((g) => (g.id === guide.id ? guide : g))
      );
    } else if (guide.scope === "conversation" && guide.conversationId) {
      setConversationGuides((prev) => {
        const list = prev[guide.conversationId!] || [];
        return {
          ...prev,
          [guide.conversationId!]: list.map((g) =>
            g.id === guide.id ? guide : g
          ),
        };
      });
    }
  };

  const handleDeleteGuide = (id: string, scope: "global" | "conversation") => {
    if (scope === "global") {
      setGlobalGuides((prev) => prev.filter((g) => g.id !== id));
    } else if (scope === "conversation" && activeConversationId) {
      setConversationGuides((prev) => ({
        ...prev,
        [activeConversationId]: (prev[activeConversationId] || []).filter(
          (g) => g.id !== id
        ),
      }));
    }
  };

  return (
    <div className="iso-app-root">
      {/* ì‚¬ì´ë“œë°” */}
      <aside className="iso-sidebar">
        <div className="iso-sidebar-header">
          <div className="iso-sidebar-title">UCONAI gpt-ISO Expert</div>
          <div className="iso-sidebar-sub">
            ISO/IEC JTC 1 SC 36 Â· PWI 26255 Â· TR 25468 êµ­ì œ í‘œì¤€ ì‘ì—… ì „ìš©
            ì–´ì‹œìŠ¤í„´íŠ¸
          </div>
          <button
            className="iso-sidebar-new-btn"
            type="button"
            onClick={handleNewConversation}
          >
            + ìƒˆ í…Œë§ˆ
          </button>
        </div>

        <div className="iso-sidebar-section" style={{flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0}}>
          <div className="iso-sidebar-section-title">í…Œë§ˆ ëª©ë¡</div>
          <ul className="iso-sidebar-conv-list" style={{flex: 1, minHeight: 0, overflowY: 'auto'}}>
            {conversations.map((c, idx) => (
              <li
                key={c.id}
                className={
                  c.id === activeConversationId
                    ? "iso-sidebar-conv-item active"
                    : "iso-sidebar-conv-item"
                }
                onClick={() => setActiveConversationId(c.id)}
                style={{ position: 'relative', paddingRight: 32 }}
              >
                <div
                  className="iso-sidebar-conv-title"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleEditTitleStart(c);
                  }}
                >
                  {editingConvId === c.id ? (
                    <input
                      type="text"
                      value={editingTitle}
                      autoFocus
                      onChange={(e) => setEditingTitle(e.target.value)}
                      onBlur={() => handleEditTitleSave(c.id)}
                      onKeyDown={(e) => {
                        if (e.key === "Enter") handleEditTitleSave(c.id);
                        if (e.key === "Escape") {
                          setEditingConvId(null);
                          setEditingTitle("");
                        }
                      }}
                    />
                  ) : (
                    <span>{c.title}</span>
                  )}
                </div>
                <div className="iso-sidebar-conv-meta">
                  {c.createdAt} Â· {c.messages.length} ë©”ì‹œì§€
                </div>
                {conversations.length > 1 && (
                  <button
                    type="button"
                    title="í…Œë§ˆ ì‚­ì œ"
                    onClick={e => {
                      e.stopPropagation();
                      // ì‚­ì œ ë¡œì§
                      setConversations(prev => {
                        const filtered = prev.filter(conv => conv.id !== c.id);
                        // ì‚­ì œëœ í…Œë§ˆê°€ í˜„ì¬ activeë©´, ì²« ë²ˆì§¸ í…Œë§ˆë¡œ ì´ë™
                        if (c.id === activeConversationId && filtered.length > 0) {
                          setActiveConversationId(filtered[0].id);
                        }
                        return filtered;
                      });
                    }}
                    style={{
                      position: 'absolute',
                      right: 4,
                      top: 8,
                      width: 20,
                      height: 20,
                      border: 'none',
                      borderRadius: 999,
                      background: '#f3f4f6',
                      color: '#b91c1c',
                      fontWeight: 700,
                      fontSize: 13,
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      zIndex: 1,
                    }}
                  >
                    Ã—
                  </button>
                )}
              </li>
            ))}
          </ul>
        </div>

        <div className="iso-sidebar-section guides">
          <div className="iso-sidebar-section-title">ì§€ì¹¨ / ê°€ì´ë“œ</div>
          <div className="iso-sidebar-guides-desc">
            í”„ë¡œì íŠ¸ ê³µí†µ ì§€ì¹¨ê³¼ ëŒ€í™”ë°© ì§€ì¹¨ì„ í†µí•© ê´€ë¦¬í•©ë‹ˆë‹¤.
          </div>
          <button
            type="button"
            onClick={() => setIsGuidePanelOpen(true)}
            style={{
              marginTop: 8,
              width: "100%",
              borderRadius: 999,
              border: "1px solid #4b5563",
              background: "transparent",
              color: "#e5e7eb",
              fontSize: 12,
              padding: "6px 10px",
              cursor: "pointer",
            }}
          >
            ì§€ì¹¨ / ê°€ì´ë“œ ê´€ë¦¬
          </button>
        </div>
      </aside>

      {/* ë©”ì¸ */}
      <main className="iso-main">
        <div className="iso-main-card">
          <div className="iso-main-card-header">
            <h1 className="iso-main-title">ISO/IECê°œë°œ AI ì„œí¬í„° - ìœ ì½”ë‚˜ì´</h1>
            <p className="iso-main-subtitle">
              ISO/IEC TR 25468 / IS-PWI 26255 - Metaverse LET ê°œë°œ ì§€ì›
            </p>
          </div>

          {/* ëª¨ë¸ / ì‹¤í–‰ ë°©ì‹ */}
          <div className="iso-main-controls">
            <div className="iso-main-control">
              <label className="iso-label">ëª¨ë¸</label>
              <select
                value={model}
                onChange={(e) => setModel(e.target.value as ModelOption)}
              >
                {modelList.map((m) => (
                  <option key={m.id} value={m.id}>
                    {m.label}
                  </option>
                ))}
              </select>
            </div>
            <div className="iso-main-control">
              <label className="iso-label">ì‹¤í–‰ ë°©ì‹</label>
              <select
                value={runMode}
                onChange={(e) => setRunMode(e.target.value as RunMode)}
              >
                <option value="chat">ì¼ë°˜ ì‹¤í–‰ (Chat API)</option>
                <option value="responses">ê³ ê¸‰ ì‹¤í–‰ (Responses API)</option>
              </select>
            </div>
          </div>

          {/* ë‹µë³€ ëª¨ë“œ */}
          <div className="iso-main-controls" style={{ marginTop: 4 }}>
            <div className="iso-main-control" style={{ flex: 1 }}>
              <label className="iso-label">ë‹µë³€ ëª¨ë“œ</label>
              <div style={{ display: "flex", gap: 32, justifyContent: "center", marginTop: 4 }}>
                <div style={{ display: "flex", flexDirection: "column", alignItems: "center" }}>
                  <button
                    type="button"
                    className={"iso-answer-btn" + (answerMode === "strict" ? " active" : "")}
                    onClick={() => setAnswerMode("strict")}
                    style={{ borderRadius: 999, fontWeight: 600, padding: "6px 18px", background: answerMode === "strict" ? "#5b21b6" : "#ede9fe", color: answerMode === "strict" ? "#fff" : "#5b21b6", border: 0, fontSize: 13, minWidth: 80, transition: 'background 0.2s, color 0.2s' }}
                  >
                    ë³´ìˆ˜í˜•
                  </button>
                  <div style={{ fontSize: 13, color: answerMode === "strict" ? "#5b21b6" : "#6b7280", marginTop: 2, fontWeight: 700 }}>ì‹¤ì²´ì  ì •ë³´ë§Œ ì œê³µ</div>
                </div>
                <div style={{ display: "flex", flexDirection: "column", alignItems: "center" }}>
                  <button
                    type="button"
                    className={"iso-answer-btn" + (answerMode === "aggressive" ? " active" : "")}
                    onClick={() => setAnswerMode("aggressive")}
                    style={{ borderRadius: 999, fontWeight: 600, padding: "6px 18px", background: answerMode === "aggressive" ? "#5b21b6" : "#ede9fe", color: answerMode === "aggressive" ? "#fff" : "#5b21b6", border: 0, fontSize: 13, minWidth: 80, transition: 'background 0.2s, color 0.2s' }}
                  >
                    ì ê·¹í˜•
                  </button>
                  <div style={{ fontSize: 13, color: answerMode === "aggressive" ? "#5b21b6" : "#6b7280", marginTop: 2, fontWeight: 700 }}>ìƒì„±í˜•AI ì •ë³´ í¬í•¨</div>
                </div>
              </div>
            </div>
          </div>

          <div className="iso-main-description">
            ISO/IEC í‘œì¤€, PWI 26255, TR 25468, ë©”íƒ€ë²„ìŠ¤ LET ë“±ì— ëŒ€í•´ ì§ˆë¬¸í•˜ë©´, ë³´ìˆ˜í˜• ë˜ëŠ” ì ê·¹í˜• ëª¨ë“œì— ë”°ë¼ ë‹µë³€í•©ë‹ˆë‹¤.
          </div>

          {/* ëŒ€í™” ì˜ì—­ */}
          <div className="iso-main-chat">{renderMessages()}</div>

          {/* ì²¨ë¶€íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° */}
          {attachedFiles.length > 0 && renderAttachedFiles()}

          {/* íŒŒì¼ ë²„íŠ¼ */}
          <div
            style={{
              display: "flex",
              alignItems: "center",
              marginTop: 6,
              marginBottom: 4,
              gap: 6,
            }}
          >
            <button
              type="button"
              aria-label="ì²¨ë¶€íŒŒì¼"
              onClick={() => fileInputRef.current?.click()}
              style={{
                borderRadius: 999,
                border: "1px solid #e5e7eb",
                width: 28,
                height: 28,
                display: "inline-flex",
                alignItems: "center",
                justifyContent: "center",
                background: "#f9fafb",
                cursor: "pointer",
              }}
            >
              <ClipIcon />
            </button>
            <span style={{ fontSize: 11, color: "#6b7280" }}>
              íŒŒì¼/ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ ì•„ì´ì½˜ì„ ëˆŒëŸ¬ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </span>
            <input
              ref={fileInputRef}
              type="file"
              multiple
              style={{ display: "none" }}
              onChange={handleFileInputChange}
              accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.txt,.zip,.hwp,.ppt,.pptx,.csv"
            />
          </div>

          {/* ì—ëŸ¬ */}
          {error && <div className="iso-error">{error}</div>}

          {/* ì…ë ¥ í¼ */}
          <form className="iso-input-form" onSubmit={handleSubmit}>
            <textarea
              className="iso-textarea"
              placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ê³  Enterë¡œ ì „ì†¡ (Shift+Enter ì¤„ë°”ê¿ˆ)"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                  e.preventDefault();
                  handleSubmit();
                }
              }}
              onDrop={handleDrop}
              onDragOver={(e) => e.preventDefault()}
            />
            <button
              type="submit"
              className="iso-submit-btn"
              disabled={loading || !input.trim()}
            >
              {loading ? "ìƒì„± ì¤‘..." : "ì „ì†¡"}
            </button>
          </form>
        </div>
      </main>

      {/* ì§€ì¹¨/ê°€ì´ë“œ íŒ¨ë„ */}
      <GuidePanel
        isOpen={isGuidePanelOpen}
        onClose={() => setIsGuidePanelOpen(false)}
        globalGuides={globalGuides}
        conversationGuides={activeConvGuides}
        activeConversationId={activeConversationId}
        onCreateGuide={handleCreateGuide}
        onUpdateGuide={handleUpdateGuide}
        onDeleteGuide={handleDeleteGuide}
      />
    </div>
  );
};

export default App;
