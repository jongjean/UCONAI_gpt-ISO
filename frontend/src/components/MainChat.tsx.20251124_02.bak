import React from "react";

export type MainChatProps = {
  messages: any[];
  onSendMessage: (msg: string) => void;
  input: string;
  setInput: (v: string) => void;
  loading: boolean;
  error: string | null;
  attachedFiles: any[];
  onRemoveFile: (id: string) => void;
  onAttachFiles?: (files: File[]) => void;
};

const MainChat: React.FC<MainChatProps> = ({
  messages,
  onSendMessage,
  input,
  setInput,
  loading,
  error,
  attachedFiles,
  onRemoveFile,
  onAttachFiles,
}) => {
  // 붙여넣기(Ctrl+V)로 파일 첨부 지원
  const handlePaste = (e: React.ClipboardEvent<HTMLTextAreaElement>) => {
    if (e.clipboardData && onAttachFiles) {
      const files: File[] = Array.from(e.clipboardData.files);
      if (files.length > 0) {
        e.preventDefault();
        onAttachFiles(files);
      }
    }
  };
  return (
    <main className="iso-main">
      <div className="iso-main-card">
        <div className="iso-main-card-header">
          <h1 className="iso-main-title">ISO/IEC개발 AI 서포터 - 유코나이</h1>
          <p className="iso-main-subtitle">
            ISO/IEC TR 25468 / IS-PWI 26255 - Metaverse LET 개발 지원
          </p>
        </div>

        {/* 대화 영역 */}
        <div className="iso-main-chat">
          {messages.length === 0 ? (
            <div className="iso-chat-empty">아직 대화가 없습니다.</div>
          ) : (
            <div className="iso-chat-messages">
              {messages.map((msg, idx) => (
                <div
                  key={idx}
                  className={
                    "iso-chat-bubble " + (msg.role === "user" ? "user" : "ai")
                  }
                >
                  <div
                    style={{
                      display: "flex",
                      alignItems: "center",
                      marginBottom: 2,
                    }}
                  >
                    <span
                      style={{
                        background: "#5b21b6",
                        color: "#fff",
                        borderRadius: 999,
                        padding: "2px 16px",
                        fontWeight: 600,
                        fontSize: 12,
                        marginRight: 8,
                        display: "inline-block",
                        minWidth: 36,
                        textAlign: "center",
                      }}
                    >
                      {msg.role === "user" ? "강박사님" : "유코나이-ISO Expert"}
                    </span>
                  </div>
                  <div className="iso-chat-bubble-content">{msg.content}</div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* 첨부파일 미리보기 */}
        {attachedFiles.length > 0 && (
          <div style={{ fontSize: 11, color: "#6b7280", marginTop: 4 }}>
            {attachedFiles.map((file) => (
              <span
                key={file.id}
                style={{
                  display: "inline-flex",
                  alignItems: "center",
                  padding: "2px 6px",
                  borderRadius: 999,
                  background: "#e5e7eb",
                  marginRight: 4,
                  marginBottom: 2,
                }}
              >
                {file.name}
                <button
                  type="button"
                  onClick={() => onRemoveFile(file.id)}
                  style={{
                    marginLeft: 4,
                    border: 0,
                    background: "transparent",
                    color: "#b91c1c",
                    cursor: "pointer",
                    fontSize: 11,
                  }}
                >
                  ×
                </button>
              </span>
            ))}
          </div>
        )}

        {/* 에러 */}
        {error && <div className="iso-error">{error}</div>}

        {/* 입력 폼 */}
        <form
          className="iso-input-form"
          onSubmit={(e) => {
            e.preventDefault();
            if (!loading && input.trim()) {
              onSendMessage(input);
            }
          }}
        >
          <textarea
            className="iso-textarea"
            placeholder="질문을 입력하고 Enter로 전송 (Shift+Enter 줄바꿈)"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                if (!loading && input.trim()) {
                  onSendMessage(input);
                }
              }
            }}
            onPaste={handlePaste}
          />
          <button
            type="submit"
            className="iso-submit-btn"
            disabled={loading || !input.trim()}
          >
            {loading ? "생성 중..." : "전송"}
          </button>
        </form>
      </div>
    </main>
  );
};

export default MainChat;
