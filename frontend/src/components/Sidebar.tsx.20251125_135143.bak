// src/components/Sidebar.tsx

import React, { useState } from "react";
import { Conversation } from "../types/isoApp";

interface SidebarProps {
  conversations: Conversation[];
  activeConversationId: string | null;
  onNewConversation: () => void;
  onSelectConversation: (id: string) => void;
  onDeleteConversation: (id: string) => void;
  editingConvId: string | null;
  editingTitle: string;
  onEditTitleStart: (conv: Conversation) => void;
  onEditTitleSave: (id: string) => void;
  setEditingTitle: (title: string) => void;
  onReorderConversations?: (from: number, to: number) => void;
  onOpenGuidePanel?: () => void; // 좌측에서 지침 패널 열고 싶을 때 사용
}

const Sidebar: React.FC<SidebarProps> = ({
  conversations,
  activeConversationId,
  onNewConversation,
  onSelectConversation,
  onDeleteConversation,
  editingConvId,
  editingTitle,
  onEditTitleStart,
  onEditTitleSave,
  setEditingTitle,
  onReorderConversations,
  onOpenGuidePanel,
}) => {
  // 드래그 정렬 상태
  const [dragIndex, setDragIndex] = useState<number | null>(null);
  const [hoverIndex, setHoverIndex] = useState<number | null>(null);

  const handleDragStart = (idx: number) => setDragIndex(idx);

  const handleDragOver = (idx: number, e: React.DragEvent) => {
    e.preventDefault();
    setHoverIndex(idx);
  };

  const handleDrop = (idx: number) => {
    if (dragIndex !== null && dragIndex !== idx && onReorderConversations) {
      onReorderConversations(dragIndex, idx);
    }
    setDragIndex(null);
    setHoverIndex(null);
  };

  const handleDragEnd = () => {
    setDragIndex(null);
    setHoverIndex(null);
  };

  return (
    <aside className="iso-sidebar">
      <div className="iso-sidebar-header">
        <div className="iso-sidebar-title">UCONAI gpt-ISO Expert</div>
        <div className="iso-sidebar-sub">
          ISO/IEC JTC 1 SC 36 · PWI 26255 · TR 25468 국제 표준 작업 전용 어시스턴트
        </div>
        <button
          className="iso-sidebar-new-btn"
          type="button"
          onClick={onNewConversation}
        >
          + 새 테마
        </button>
      </div>

      <div className="iso-sidebar-section theme-list">
        <div className="iso-sidebar-section-title">테마 목록</div>
        <ul className="iso-sidebar-conv-list">
          {conversations.map((c, idx) => {
            const isActive = c.id === activeConversationId;
            const isDragging = dragIndex === idx;
            const isHover = hoverIndex === idx && dragIndex !== null;

            return (
              <li
                key={c.id}
                className={
                  isActive
                    ? "iso-sidebar-conv-item active"
                    : "iso-sidebar-conv-item"
                }
                onClick={() => onSelectConversation(c.id)}
                draggable={!!onReorderConversations}
                onDragStart={() => handleDragStart(idx)}
                onDragOver={(e) => handleDragOver(idx, e)}
                onDrop={() => handleDrop(idx)}
                onDragEnd={handleDragEnd}
                style={{
                  opacity: isDragging ? 0.7 : 1,
                  backgroundColor: isHover ? "#111827" : undefined,
                  transition: "background 0.15s, opacity 0.15s",
                }}
              >
                <div style={{ position: "relative", minHeight: 16 }}>
                  {conversations.length > 1 && (
                    <button
                      type="button"
                      title="테마 삭제"
                      className="iso-sidebar-conv-xbtn"
                      onClick={(e) => {
                        e.stopPropagation();
                        if (
                          window.confirm("정말 이 테마를 삭제하시겠습니까?")
                        ) {
                          onDeleteConversation(c.id);
                        }
                      }}
                      tabIndex={-1}
                    >
                      <span
                        style={{
                          fontSize: 10,
                          lineHeight: 1,
                          pointerEvents: "none",
                        }}
                      >
                        ×
                      </span>
                    </button>
                  )}

                  <div
                    className="iso-sidebar-conv-title"
                    onClick={(e) => {
                      e.stopPropagation();
                      onEditTitleStart(c);
                    }}
                  >
                    {editingConvId === c.id ? (
                      <input
                        type="text"
                        value={editingTitle}
                        autoFocus
                        onChange={(e) => setEditingTitle(e.target.value)}
                        onBlur={() => onEditTitleSave(c.id)}
                        onKeyDown={(e) => {
                          if (e.key === "Enter") onEditTitleSave(c.id);
                          if (e.key === "Escape") {
                            // 취소: 단순히 편집 상태만 해제
                            onEditTitleSave(c.id);
                          }
                        }}
                      />
                    ) : (
                      <span>{c.title}</span>
                    )}
                  </div>

                  <div className="iso-sidebar-conv-meta">
                    {(() => {
                      const dateMatch = c.createdAt.match(
                        /^(\d{4}\. ?\d{1,2}\. ?\d{1,2}\.)/
                      );
                      const timeMatch = c.createdAt.match(
                        /(오전|오후)\s*\d{1,2}:\d{2}/
                      );
                      const date = dateMatch ? dateMatch[1].trim() : "";
                      const time = timeMatch ? timeMatch[0] : "";
                      return (
                        <>
                          {date}
                          {time ? ` ${time}` : ""}
                          {` · ${c.messages.length} 메시지`}
                        </>
                      );
                    })()}
                  </div>
                </div>
              </li>
            );
          })}
        </ul>
      </div>

      <div className="iso-sidebar-section guides">
        <div className="iso-sidebar-section-title">지침 / 가이드</div>
        <div className="iso-sidebar-guides-desc">
          프로젝트 공통 지침과 대화방 지침을 통합 관리합니다.
        </div>
        {onOpenGuidePanel && (
          <button
            type="button"
            onClick={onOpenGuidePanel}
            style={{
              marginTop: 8,
              width: "100%",
              borderRadius: 999,
              border: "1px solid #4b5563",
              background: "transparent",
              color: "#e5e7eb",
              fontSize: 12,
              padding: "6px 10px",
              cursor: "pointer",
            }}
          >
            지침 / 가이드 패널 열기
          </button>
        )}
      </div>
    </aside>
  );
};

export default Sidebar;
