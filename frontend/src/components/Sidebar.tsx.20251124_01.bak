import React from "react";

export type SidebarProps = {
  conversations: any[];
  activeConversationId: string;
  onNewConversation: () => void;
  onSelectConversation: (id: string) => void;
  onDeleteConversation: (id: string) => void;
  editingConvId: string | null;
  editingTitle: string;
  onEditTitleStart: (conv: any) => void;
  onEditTitleSave: (id: string) => void;
  setEditingTitle: (title: string) => void;
};

const Sidebar: React.FC<SidebarProps> = ({
  conversations,
  activeConversationId,
  onNewConversation,
  onSelectConversation,
  onDeleteConversation,
  editingConvId,
  editingTitle,
  onEditTitleStart,
  onEditTitleSave,
  setEditingTitle,
}) => {
  return (
    <aside className="iso-sidebar">
      <div className="iso-sidebar-header">
        <div className="iso-sidebar-title">UCONAI gpt-ISO Expert</div>
        <div className="iso-sidebar-sub">
          ISO/IEC JTC 1 SC 36 · PWI 26255 · TR 25468 국제 표준 작업 전용 어시스턴트
        </div>
        <button
          className="iso-sidebar-new-btn"
          type="button"
          onClick={onNewConversation}
        >
          + 새 테마
        </button>
      </div>

      <div className="iso-sidebar-section theme-list">
        <div className="iso-sidebar-section-title">테마 목록</div>
        <ul
          className="iso-sidebar-conv-list"
          style={{ flex: 1, minHeight: 0, overflowY: "auto" }}
        >
          {conversations.map((c) => (
            <li
              key={c.id}
              className={
                c.id === activeConversationId
                  ? "iso-sidebar-conv-item active"
                  : "iso-sidebar-conv-item"
              }
              onClick={() => onSelectConversation(c.id)}
              style={{ position: "relative" }}
            >
              <div style={{ position: "relative", minHeight: 16 }}>
                {conversations.length > 1 && (
                  <button
                    type="button"
                    title="테마 삭제"
                    className="iso-sidebar-conv-xbtn"
                    onClick={(e) => {
                      e.stopPropagation();
                      if (window.confirm("정말 이 테마를 삭제하시겠습니까?")) {
                        onDeleteConversation(c.id);
                      }
                    }}
                    tabIndex={-1}
                  >
                    <span
                      style={{
                        fontSize: 10,
                        lineHeight: 1,
                        pointerEvents: "none",
                      }}
                    >
                      ×
                    </span>
                  </button>
                )}
                <div
                  className="iso-sidebar-conv-title"
                  onClick={(e) => {
                    e.stopPropagation();
                    onEditTitleStart(c);
                  }}
                >
                  {editingConvId === c.id ? (
                    <input
                      type="text"
                      value={editingTitle}
                      autoFocus
                      onChange={(e) => setEditingTitle(e.target.value)}
                      onBlur={() => onEditTitleSave(c.id)}
                      onKeyDown={(e) => {
                        if (e.key === "Enter") onEditTitleSave(c.id);
                        if (e.key === "Escape") {
                          onEditTitleSave("");
                        }
                      }}
                    />
                  ) : (
                    <span>{c.title}</span>
                  )}
                </div>
                <div className="iso-sidebar-conv-meta">
                  {(() => {
                    const dateMatch = c.createdAt.match(
                      /^(\d{4}\. ?\d{1,2}\. ?\d{1,2}\.)/
                    );
                    const timeMatch = c.createdAt.match(
                      /(오전|오후)\s*\d{1,2}:\d{2}/
                    );
                    const date = dateMatch ? dateMatch[1].trim() : "";
                    const time = timeMatch ? timeMatch[0] : "";
                    return (
                      date +
                      (time ? " " + time : "") +
                      " · " +
                      c.messages.length +
                      " 메시지"
                    );
                  })()}
                </div>
              </div>
            </li>
          ))}
        </ul>
      </div>

      <div className="iso-sidebar-section guides">
        <div className="iso-sidebar-section-title">지침 / 가이드</div>
        <div className="iso-sidebar-guides-desc">
          프로젝트 공통 지침과 대화방 지침을 통합 관리합니다.
        </div>
        {/* 가이드 패널 오픈 버튼은 App에서 직접 관리 */}
      </div>
    </aside>
  );
};

export default Sidebar;
