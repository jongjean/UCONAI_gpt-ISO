// src/components/GuidePanel.tsx
import React, { useEffect, useRef, useState } from "react";
import { Guide, GuideFile } from "../types/isoChat";

export type GuidePanelProps = {
  isOpen: boolean;
  onClose: () => void;
  globalGuides: Guide[];
  /** 현재 활성 테마의 지침 목록만 전달 */
  conversationGuides: Guide[];
  activeConversationId: string | null;
  onCreateGuide: (scope: "global" | "conversation") => void;
  onUpdateGuide: (guide: Guide) => void;
  onDeleteGuide: (id: string, scope: "global" | "conversation") => void;
};

type Tab = "global" | "conversation";

// 파일 중복 방지를 위한 시그니처
const fileSignature = (f: File) => `${f.name}-${f.size}-${f.lastModified}`;

const GuidePanel: React.FC<GuidePanelProps> = (props) => {
  const {
    isOpen,
    onClose,
    globalGuides,
    conversationGuides,
    activeConversationId,
    onCreateGuide,
    onUpdateGuide,
    onDeleteGuide,
  } = props;

  const [tab, setTab] = useState<Tab>("global");
  const [editing, setEditing] = useState<Guide | null>(null);

  // 패널 위치/크기
  const [pos, setPos] = useState({ x: window.innerWidth / 2 - 360, y: 60 });
  const [size, setSize] = useState({ width: 720, height: 560 });

  const [dragging, setDragging] = useState(false);
  const dragOffsetRef = useRef({ x: 0, y: 0 });

  const [resizing, setResizing] = useState(false);
  const resizeStartRef = useRef({
    x: 0,
    y: 0,
    width: 720,
    height: 560,
  });

  const fileInputRef = useRef<HTMLInputElement>(null);

  const currentList: Guide[] =
    tab === "global" ? globalGuides : conversationGuides;

  // 처음 열릴 때 / 탭 변경 시 기본 선택
  useEffect(() => {
    if (!isOpen) {
      setEditing(null);
      return;
    }

    const list = currentList;
    if (list.length === 0) {
      setEditing(null);
      return;
    }

    // 현재 editing 이 사라졌다면 첫 번째로 교체
    if (!editing || !list.some((g) => g.id === editing.id)) {
      setEditing(list[0]);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen, tab, globalGuides, conversationGuides, activeConversationId]);

  // 패널 드래그
  const handleDragMouseDown = (e: React.MouseEvent) => {
    e.preventDefault();
    setDragging(true);
    dragOffsetRef.current = {
      x: e.clientX - pos.x,
      y: e.clientY - pos.y,
    };
  };

  // 리사이즈
  const handleResizeMouseDown = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setResizing(true);
    resizeStartRef.current = {
      x: e.clientX,
      y: e.clientY,
      width: size.width,
      height: size.height,
    };
  };

  useEffect(() => {
    if (!dragging && !resizing) return;

    const handleMouseMove = (e: MouseEvent) => {
      if (dragging) {
        const { x: ox, y: oy } = dragOffsetRef.current;
        const rawX = e.clientX - ox;
        const rawY = e.clientY - oy;

        const maxX = window.innerWidth - size.width;
        const maxY = window.innerHeight - size.height;

        setPos({
          x: Math.max(0, Math.min(maxX, rawX)),
          y: Math.max(0, Math.min(maxY, rawY)),
        });
      } else if (resizing) {
        const start = resizeStartRef.current;
        const dx = e.clientX - start.x;
        const dy = e.clientY - start.y;

        let newWidth = start.width + dx;
        let newHeight = start.height + dy;

        const maxWidth = window.innerWidth * 0.95;
        const maxHeight = window.innerHeight * 0.9;

        newWidth = Math.max(480, Math.min(maxWidth, newWidth));
        newHeight = Math.max(360, Math.min(maxHeight, newHeight));

        setSize({ width: newWidth, height: newHeight });
      }
    };

    const handleMouseUp = () => {
      setDragging(false);
      setResizing(false);
    };

    window.addEventListener("mousemove", handleMouseMove);
    window.addEventListener("mouseup", handleMouseUp);
    return () => {
      window.removeEventListener("mousemove", handleMouseMove);
      window.removeEventListener("mouseup", handleMouseUp);
    };
  }, [dragging, resizing, size.width, size.height]);

  // 파일 첨부 공통 로직 (중복 방지)
  const safeAddFiles = (files: File[]) => {
    if (!editing) return;
    if (!files.length) return;

    const existing = new Set(
      (editing.files || []).map(
        (f: GuideFile) => `${f.name}-${f.size}-${f.createdAt ?? ""}`
      )
    );

    const filtered = files.filter(
      (f) => !existing.has(fileSignature(f))
    );
    if (!filtered.length) return;

    const now = new Date().toISOString();
    const newGuideFiles: GuideFile[] = filtered.map((f) => ({
      id: `gf-${Date.now()}-${Math.random().toString(36).slice(2)}`,
      name: f.name,
      size: f.size,
      type: f.type,
      url: "",
      createdAt: now,
    }));

    const updated: Guide = {
      ...editing,
      files: [...(editing.files || []), ...newGuideFiles],
      updatedAt: now,
    };

    setEditing(updated);
    onUpdateGuide(updated);
  };

  // 붙여넣기 / 드롭 / input change 핸들러
  const handlePasteBoxPaste = (e: React.ClipboardEvent<HTMLDivElement>) => {
    const files = Array.from(e.clipboardData.files || []);
    if (!files.length) return;
    e.preventDefault();
    safeAddFiles(files);
  };

  const handlePasteGlobal = (e: ClipboardEvent) => {
    if (!isOpen || !editing) return;
    const files = Array.from(e.clipboardData?.files || []);
    if (!files.length) return;
    e.preventDefault();
    safeAddFiles(files);
  };

  useEffect(() => {
    if (!isOpen) return;
    const handler = (e: ClipboardEvent) => handlePasteGlobal(e);
    window.addEventListener("paste", handler);
    return () => window.removeEventListener("paste", handler);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen, editing]);

  const handleDropBoxDrop = (e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
    const files = Array.from(e.dataTransfer.files || []);
    if (!files.length) return;
    safeAddFiles(files);
  };

  const handleFileInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    safeAddFiles(files);
    e.target.value = "";
  };

  const handleRemoveGuideFile = (fileId: string) => {
    if (!editing) return;
    const now = new Date().toISOString();
    const updated: Guide = {
      ...editing,
      files: (editing.files || []).filter((f) => f.id !== fileId),
      updatedAt: now,
    };
    setEditing(updated);
    onUpdateGuide(updated);
  };

  const handleChangeTitle = (value: string) => {
    if (!editing) return;
    const updated: Guide = {
      ...editing,
      title: value,
      updatedAt: new Date().toISOString(),
    };
    setEditing(updated);
    onUpdateGuide(updated);
  };

  const handleChangeContent = (value: string) => {
    if (!editing) return;
    const updated: Guide = {
      ...editing,
      content: value,
      updatedAt: new Date().toISOString(),
    };
    setEditing(updated);
    onUpdateGuide(updated);
  };

  if (!isOpen) return null;

  return (
    <>
      {/* 어두운 배경 – 드래그 중에는 닫히지 않게 */}
      <div
        style={{
          position: "fixed",
          inset: 0,
          background: "rgba(0,0,0,0.45)",
          zIndex: 1000,
        }}
        onClick={() => {
          if (!dragging && !resizing) onClose();
        }}
      />

      {/* 플로팅 패널 */}
      <div
        style={{
          position: "fixed",
          left: pos.x,
          top: pos.y,
          width: size.width,
          height: size.height,
          maxWidth: "95vw",
          maxHeight: "90vh",
          background: "#020617",
          color: "#f9fafb",
          borderRadius: 16,
          boxShadow: "0 20px 60px rgba(0,0,0,0.45)",
          zIndex: 1001,
          display: "flex",
          flexDirection: "column",
          boxSizing: "border-box",
          padding: 20,
          cursor: dragging ? "grabbing" : "default",
        }}
      >
        {/* 상단 헤더 + 드래그 핸들 */}
        <div
          style={{
            display: "flex",
            alignItems: "center",
            marginBottom: 12,
            gap: 8,
          }}
        >
          <div
            onMouseDown={handleDragMouseDown}
            style={{
              width: 30,
              height: 30,
              borderRadius: 8,
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              cursor: "grab",
              background: "rgba(148,163,184,0.08)",
              userSelect: "none",
            }}
            title="패널 이동"
          >
            <span style={{ fontSize: 16, opacity: 0.8 }}>⋮⋮</span>
          </div>

          <div style={{ flex: 1, minWidth: 0 }}>
            <div style={{ fontWeight: 600, fontSize: 14 }}>
              지침 / 가이드 관리
            </div>
            <div
              style={{
                fontSize: 11,
                color: "#9ca3af",
                marginTop: 2,
              }}
            >
              프로젝트 공통 지침과 테마방 지침을 구분해 관리합니다.
            </div>
          </div>

          <button
            type="button"
            onClick={onClose}
            style={{
              border: 0,
              borderRadius: "999px",
              width: 28,
              height: 28,
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              background: "#111827",
              color: "#e5e7eb",
              cursor: "pointer",
              fontWeight: 700,
              fontSize: 16,
            }}
            aria-label="닫기"
          >
            ×
          </button>
        </div>

        {/* 탭 */}
        <div
          style={{
            display: "flex",
            gap: 8,
            marginBottom: 12,
          }}
        >
          <button
            type="button"
            onClick={() => setTab("global")}
            style={{
              flex: 1,
              borderRadius: 999,
              border: 0,
              padding: "6px 10px",
              fontSize: 12,
              cursor: "pointer",
              background: tab === "global" ? "#7c3aed" : "#111827",
              color: tab === "global" ? "#fff" : "#e5e7eb",
            }}
          >
            프로젝트 공통 지침
          </button>
          <button
            type="button"
            onClick={() => setTab("conversation")}
            disabled={!activeConversationId}
            style={{
              flex: 1,
              borderRadius: 999,
              border: 0,
              padding: "6px 10px",
              fontSize: 12,
              cursor: activeConversationId ? "pointer" : "not-allowed",
              opacity: activeConversationId ? 1 : 0.5,
              background: tab === "conversation" ? "#7c3aed" : "#111827",
              color: tab === "conversation" ? "#fff" : "#e5e7eb",
            }}
          >
            테마방 지침
          </button>
        </div>

        {/* 본문: 좌측 리스트 / 우측 편집 */}
        <div
          style={{
            flex: 1,
            display: "flex",
            gap: 16,
            minHeight: 260,
            overflow: "hidden",
          }}
        >
          {/* 좌측: 리스트 */}
          <div
            style={{
              flex: "0 0 260px",
              maxWidth: 300,
              minWidth: 220,
              display: "flex",
              flexDirection: "column",
            }}
          >
            <button
              type="button"
              onClick={() => onCreateGuide(tab)}
              style={{
                alignSelf: "flex-start",
                marginBottom: 8,
                borderRadius: 8,
                border: 0,
                padding: "6px 10px",
                fontSize: 12,
                background: "#7c3aed",
                color: "#fff",
                cursor: "pointer",
              }}
            >
              + 새 지침 추가
            </button>

            <div
              style={{
                flex: 1,
                borderRadius: 10,
                border: "1px solid #1f2937",
                background: "#020617",
                overflowY: "auto",
              }}
            >
              {currentList.length === 0 ? (
                <div
                  style={{
                    padding: 10,
                    fontSize: 12,
                    color: "#9ca3af",
                  }}
                >
                  아직 등록된 지침이 없습니다.
                </div>
              ) : (
                currentList.map((g) => (
                  <div
                    key={g.id}
                    onClick={() => setEditing(g)}
                    style={{
                      padding: "8px 10px",
                      borderBottom: "1px solid #1f2937",
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "space-between",
                      cursor: "pointer",
                      background:
                        editing && editing.id === g.id
                          ? "rgba(129,140,248,0.18)"
                          : "transparent",
                    }}
                  >
                    <span
                      style={{
                        fontSize: 13,
                        color: "#e5e7eb",
                        overflow: "hidden",
                        whiteSpace: "nowrap",
                        textOverflow: "ellipsis",
                        maxWidth: "85%",
                      }}
                    >
                      {g.title || "(제목 없음)"}
                    </span>
                    <button
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        onDeleteGuide(g.id, g.scope);
                        if (editing && editing.id === g.id) {
                          setEditing(null);
                        }
                      }}
                      style={{
                        border: 0,
                        background: "transparent",
                        color: "#f97373",
                        fontSize: 14,
                        fontWeight: 700,
                        cursor: "pointer",
                      }}
                      aria-label="지침 삭제"
                    >
                      ×
                    </button>
                  </div>
                ))
              )}
            </div>
          </div>

          {/* 우측: 편집 */}
          <div
            style={{
              flex: "1 1 auto",
              minWidth: 0,
              display: "flex",
              flexDirection: "column",
            }}
          >
            {editing ? (
              <>
                <input
                  value={editing.title}
                  onChange={(e) => handleChangeTitle(e.target.value)}
                  placeholder="지침 제목"
                  style={{
                    width: "100%",
                    marginBottom: 8,
                    borderRadius: 8,
                    border: "1px solid #1f2937",
                    padding: 8,
                    fontSize: 13,
                    background: "#020617",
                    color: "#f9fafb",
                  }}
                />

                {/* 얇은 첨부 / Ctrl+V 박스 */}
                <div
                  style={{
                    display: "flex",
                    justifyContent: "flex-start",
                    marginBottom: 8,
                  }}
                >
                  <div
                    onPaste={handlePasteBoxPaste}
                    onDrop={handleDropBoxDrop}
                    onDragOver={(e) => e.preventDefault()}
                    onClick={() => fileInputRef.current?.click()}
                    style={{
                      border: "2px dashed #7c3aed",
                      borderRadius: 8,
                      padding: "6px 10px",
                      fontSize: 12,
                      color: "#d1d5db",
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                      height: 34,
                      width: "48%",
                      minWidth: 160,
                      cursor: "pointer",
                      background: "rgba(124,58,237,0.08)",
                      userSelect: "none",
                    }}
                    title="클릭하여 파일 첨부, 또는 Ctrl+V / 드래그로 첨부"
                  >
                    첨부 / Ctrl+V
                    <input
                      ref={fileInputRef}
                      type="file"
                      multiple
                      style={{ display: "none" }}
                      onChange={handleFileInputChange}
                      accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.txt,.zip,.ppt,.pptx,.csv"
                    />
                  </div>
                </div>

                {/* 첨부 파일 리스트 */}
                {editing.files && editing.files.length > 0 && (
                  <div
                    style={{
                      marginBottom: 8,
                      padding: 8,
                      borderRadius: 8,
                      border: "1px solid #1f2937",
                      background: "#020617",
                      maxHeight: 120,
                      overflowY: "auto",
                    }}
                  >
                    {editing.files.map((f) => (
                      <div
                        key={f.id}
                        style={{
                          display: "flex",
                          alignItems: "center",
                          justifyContent: "space-between",
                          fontSize: 11,
                          padding: "2px 0",
                          borderBottom: "1px solid #0f172a",
                        }}
                      >
                        <span
                          style={{
                            maxWidth: 260,
                            overflow: "hidden",
                            whiteSpace: "nowrap",
                            textOverflow: "ellipsis",
                          }}
                        >
                          {f.name}
                        </span>
                        <button
                          type="button"
                          onClick={() => handleRemoveGuideFile(f.id)}
                          style={{
                            border: 0,
                            background: "transparent",
                            color: "#f97373",
                            cursor: "pointer",
                            fontSize: 11,
                          }}
                        >
                          삭제
                        </button>
                      </div>
                    ))}
                  </div>
                )}

                <textarea
                  value={editing.content}
                  onChange={(e) => handleChangeContent(e.target.value)}
                  placeholder="지침 내용 또는 ISO/법률 작성 가이드라인을 입력하세요."
                  style={{
                    flex: 1,
                    width: "100%",
                    borderRadius: 8,
                    border: "1px solid #1f2937",
                    padding: 10,
                    fontSize: 13,
                    background: "#020617",
                    color: "#f9fafb",
                    resize: "none",
                  }}
                />
                <div
                  style={{
                    marginTop: 6,
                    fontSize: 11,
                    color: "#9ca3af",
                  }}
                >
                  ※ PDF/워드/이미지 등은 첨부만 하고, 본문에는 핵심 규칙과
                  요약을 텍스트로 정리하는 것을 권장합니다.
                </div>
              </>
            ) : (
              <div
                style={{
                  flex: 1,
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  fontSize: 12,
                  color: "#9ca3af",
                  textAlign: "center",
                }}
              >
                좌측에서 지침을 선택하거나 &quot;새 지침 추가&quot; 버튼을 눌러
                편집을 시작하세요.
              </div>
            )}
          </div>
        </div>

        {/* 오른쪽 아래 리사이즈 핸들 */}
        <div
          onMouseDown={handleResizeMouseDown}
          style={{
            position: "absolute",
            right: 10,
            bottom: 6,
            width: 22,
            height: 22,
            display: "flex",
            alignItems: "flex-end",
            justifyContent: "flex-end",
            fontSize: 16,
            color: "#6b7280",
            cursor: "nwse-resize",
            userSelect: "none",
          }}
          title="크기 조절"
        >
          ↘
        </div>
      </div>
    </>
  );
};

export default GuidePanel;
